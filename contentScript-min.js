var parliamentData,locale="fr",nameList=[],localData=localStorage.getItem("parliamentarians"),currentPeople={},POTENCY_WEIGHT={HIGH:1e3,MEDIUM:50,LOW:1},groupBy=function(n,e){return n.reduce(function(n,a){return(n[a[e]]=n[a[e]]||[]).push(a),n},{})};function getDataWho(n){return n.normalize("NFD").replace(/[\u0300-\u036f]/g,""),n.replace(" ","-").toLowerCase()}function getParty(n){return"partyMembership"in n&&"party"in n.partyMembership&&"abbr"in n.partyMembership.party?n.partyMembership.party.abbr:(console.log("party not found"),"")}function getVia(n){if(n.length>0)return"(via "+n[0].to.name+")"}function getIndividualData(n){var e=!1;return $.each(parliamentData.data.parliamentarians,function(a,t){t.name!==n||(e=t)}),e}function fetchParliamentIds(){$.ajax({method:"POST",url:"https://web.tcch.ch/parliament/",success:function(n,e){console.log("Data retrieved"),localStorage.setItem("parliamentarians",n),n.data.parliamentarians.forEach(function(n){nameList.push(n.name)})},error:function(n,e,a){console.log("Error when fetching parliament data")}})}function lookupNames(){var n=$("p");if(n.length>0){for(i in n)if(n[i].innerHTML){0;var e=n[i].innerHTML;nameList.forEach(function(a){if(-1!==e.indexOf(a)){var t=getDataWho(a);currentPeople[t]=a,n[i].innerHTML=e.replace(a,'<span class="modal-available '+t+'" data-who="'+t+'">'+a+"</span>")}})}}setTimeout(function(){$("span.modal-available").on("click mouseover",function(n){console.log("Survol / click sur "+$(this).data("who")),eventHandler($(this).data("who"))})},200)}function eventHandler(n){var e=getIndividualData(currentPeople[n]);if(!e)return console.log("Not found in data"),!1;console.log("Data found for "+currentPeople[n]);var a=getParty(e);function t(n){return'<li class="list-header">'+n+"</li>"}function r(n){return'<li class="list-item">'+n+"</li>"}var i=`<div class="person">\n      <div class="person-picture" style="background-image: url('${e.portrait}')"></div>\n      <div class="person-txt">\n        <div class="person-txt-header">\n          <span class="person-name"><a target="_blank" href="https://lobbywatch.ch/fr/daten/parlamentarier/${e.id}/${e.name}">${e.name}</a></span>\n          <div class="person-infos">${e.councilTitle}, ${e.canton}, ${a}</div>\n        </div>\n\n        <div class="person-text-body">\n          <ul class="person-links-list">\n            <li>${chrome.i18n.getMessage("loadingInterests")}</li>\n          </ul>\n        </div>\n\n    </div>\n  </div>`;document.querySelector(".modal-available");tippy(".modal-available."+n,{content:i,aria:null,autoFocus:!1,trigger:"click",appendTo:n=>n.parentNode,onMount({reference:n}){n.setAttribute("aria-expanded","true")},onHide({reference:n}){n.setAttribute("aria-expanded","false")},placement:"bottom",arrow:!0,interactive:!0,distance:7,animation:"fade",theme:"light-border dropdown",updateDuration:0,onShow(i){function o(n){if(console.log(n),!i.loaded){'<p class="individual-info">'+("<b>"+chrome.i18n.getMessage("tipInterests")+"</b>")+"</p>",li_str="";var o=n.data.getParliamentarian.guests,s=[];o.length>0&&o.forEach(function(n){s.push(n.name),r(n.name)});var l=groupBy(n.data.getParliamentarian.connections,"potency");function c(n){return n?(_li_str="",n.forEach(function(n){var e=getVia(n.vias);_li_str+=r(e?n.to.name+" "+e:n.to.name+", "+n.function)}),_li_str):null}var p=c(l.HIGH);p&&(li_str+=t(chrome.i18n.getMessage("tipInterestsHIGH")),li_str+=p);var d=c(l.MEDIUM);d&&(li_str+=t(chrome.i18n.getMessage("tipInterestsMEDIUM")),li_str+=d);var u=c(l.LOW);u&&(li_str+=t(chrome.i18n.getMessage("tipInterestsLOW")),li_str+=u);var m=`<div class="person">\n              <div class="person-picture" style="background-image: url('${e.portrait}')"></div>\n\n              <div class="person-txt">\n                <a class="lobbywatch-logo" target="_blank" href="https://lobbywatch.ch/fr/daten/parlamentarier/${e.id}/${e.name}">\n                  <img src="${chrome.extension.getURL("icon32.png")}" alt="Lobbywatch" />\n                </a>\n\n                <div class="person-txt-header">\n                  <span class="person-name"><a target="_blank" href="https://lobbywatch.ch/fr/daten/parlamentarier/${e.id}/${e.name}">${e.name}</a></span>\n                  <span class="person-infos">${e.councilTitle}, ${e.canton}, ${a}</span>\n                </div>\n\n                <div class="person-text-body">\n                  <p><b>${chrome.i18n.getMessage("guests")}:</b> ${s.join(", ")}</p>\n                  <ul class="person-links-list">\n                    ${li_str}\n                  </ul>\n                </div>\n\n            </div>\n\n          </div>`;i.setContent(m)}i.loaded=!0}var s=localStorage.getItem(n);if(s)data=JSON.parse(s),o(data);else{var l={query:query,variables:{locale:locale,id:e.id}};$.ajax({method:"POST",url:"https://lobbywatch.ch/graphql",contentType:"application/json",data:JSON.stringify(l),success:function(e,a){localStorage.setItem(n,JSON.stringify(e)),o(e)},error:function(){console.log("error when querying lobbywatch")}})}}})}localData?((parliamentData=JSON.parse(localData)).data.parliamentarians.forEach(function(n){nameList.push(n.name)}),console.log("Parliament: Interests loaded from localStorage")):(console.log("Parliament: fetching Interests data"),fetchParliamentIds()),lookupNames();var query="query getParliamentarian($locale: Locale!, $id: ID!) {\n  getParliamentarian(locale: $locale, id: $id) {\n    name\n    active\n    canton\n    represents\n    parliamentId\n    dateOfBirth\n    gender\n    represents\n    councilJoinDate\n    councilTenure\n    age\n    occupation\n    commissions {\n      name\n    }\n    guests {\n      id\n      name\n    }\n    connections {\n      group\n      potency\n      function\n      compensation {\n        money\n        description\n        __typename\n      }\n      from {\n        __typename\n      }\n      to {\n        __typename\n        ... on Organisation {\n          id\n          name\n          __typename\n        }\n      }\n      vias {\n        __typename\n        to {\n          ... on Guest {\n            id\n            name\n            __typename\n          }\n          __typename\n        }\n      }\n      __typename\n    }\n  }\n}";